---
timestamp: 'Sun Oct 19 2025 20:23:56 GMT-0400 (Eastern Daylight Time)'
content_id: 0f6eac5bcd7283774840411b75793bae6e90fead0ee84d77508e4c05ba977864
---

# file: src\mirrorMotionConcepts\User.test.ts

```typescript
import { assertEquals, assertExists, assertNotEquals } from "jsr:@std/assert";
import { testDb } from "@utils/database.ts";
import { ID } from "@utils/types.ts";
// Using distinct usernames for different test cases to avoid clashes
const userA = "username:Alice" as ID;
const userB = "username:Bob" as ID;
const userC = "username:Charlie" as ID;
const userD = "username:David" as ID; // For non-existent login
const userE = "username:Eve" as ID; // For incorrect password login

import UserConcept from "./UserConcept.ts";

Deno.test("Principle: After registering with a username and password, the user can log in to their account", async () => {
  const [db, client] = await testDb();
  const userConcept = new UserConcept(db);

  try {
    // 1. User creates a new user with username and password
    const createUserResult = await userConcept.register({
      username: userA,
      password: "pswTest",
    });
    assertNotEquals(
      "error" in createUserResult,
      true,
      "User creation should not fail.",
    );
    const { userID } = createUserResult as { userID: ID };
    assertExists(userID);

    // 2. User logs in with the correct username and password
    const loginResult = await userConcept.login({
      username: userA,
      password: "pswTest",
    });
    assertNotEquals(
      "error" in loginResult,
      true,
      "User login should not fail.",
    );
    const { userID: loggedInUserID } = loginResult as { userID: ID };
    assertExists(loggedInUserID);
    assertEquals(loggedInUserID, userID);
  } finally {
    await client.close();
  }
});

Deno.test("Action: register - Requires username not already taken", async () => {
  const [db, client] = await testDb();
  const userConcept = new UserConcept(db);

  try {
    // 1. Register a user successfully
    const registerResult1 = await userConcept.register({
      username: userB,
      password: "password123",
    });
    assertNotEquals(
      "error" in registerResult1,
      true,
      "First registration should succeed.",
    );
    assertExists((registerResult1 as { userID: ID }).userID);

    // 2. Attempt to register again with the same username
    const registerResult2 = await userConcept.register({
      username: userB,
      password: "anotherPassword",
    });

    // Expect an error because the username is already taken
    assertEquals(
      "error" in registerResult2,
      true,
      "Second registration with same username should fail.",
    );
    assertEquals(
      (registerResult2 as { error: string }).error,
      `Username '${userB}' is already taken.`,
      "Error message should indicate username taken.",
    );
  } finally {
    await client.close();
  }
});

Deno.test("Action: login - Requires username exists", async () => {
  const [db, client] = await testDb();
  const userConcept = new UserConcept(db);

  try {
    // 1. Attempt to login with a username that does not exist
    const loginResult = await userConcept.login({
      username: userD, // This user was never registered
      password: "anyPassword",
    });

    // Expect an error
    assertEquals(
      "error" in loginResult,
      true,
      "Login with non-existent username should fail.",
    );
    assertEquals(
      (loginResult as { error: string }).error,
      "Invalid username or password.",
      "Error message should be generic for security.",
    );
  } finally {
    await client.close();
  }
});

Deno.test("Action: login - Requires password matches", async () => {
  const [db, client] = await testDb();
  const userConcept = new UserConcept(db);

  try {
    // 1. Register a user successfully
    const registerResult = await userConcept.register({
      username: userE,
      password: "correctPassword",
    });
    assertNotEquals(
      "error" in registerResult,
      true,
      "Registration should succeed.",
    );

    // 2. Attempt to login with the correct username but incorrect password
    const loginResult = await userConcept.login({
      username: userE,
      password: "wrongPassword",
    });

    // Expect an error
    assertEquals(
      "error" in loginResult,
      true,
      "Login with incorrect password should fail.",
    );
    assertEquals(
      (loginResult as { error: string }).error,
      "Invalid username or password.",
      "Error message should be generic for security.",
    );
  } finally {
    await client.close();
  }
});

```
